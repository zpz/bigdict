#!/bin/bash

set -e

PROJ=bigdict

docker build \
    -f Dockerfile-dev \
    --build-arg PROJ=bigdict \
    -t ${PROJ}-dev:latest \
    .

SRC=/src/src/${PROJ}
TESTS=/src/tests

if [[ $# > 0 ]]; then
    if [[ $1 == 'all' ]]; then
        echo
        echo --- checking code ---
        echo
        docker run \
            --rm \
            -v $(pwd):/src \
            --workdir /src \
            -e PYTHONPATH=/src/src \
            ${PROJ}-dev:latest \
                /src/check-code
        echo
        echo --- running tests ---
        echo
        docker run \
            --rm \
            -v $(pwd):/src \
            --workdir /src \
            -e PYTHONPATH=/src/src \
            ${PROJ}-dev:latest \
                py.test \
                    --log-cli-level info \
                    --cov=/src/src/${PROJ} \
                    --cov-report term-missing \
                    --cov-fail-under 70 \
                    /src/tests
    else
        echo
        echo --- running test ---
        echo
        docker run \
            --rm \
            -v $(pwd):/src \
            --workdir /src \
            -e PYTHONPATH=/src/src \
            ${PROJ}-dev:latest \
                py.test \
                    --log-cli-level debug \
                    /src/tests/$1
    fi
else
    docker run \
        -it --rm \
        -v $(pwd):/src \
        --workdir /src \
        -e PYTHONPATH=/src/src \
        ${PROJ}-dev:latest \
        bash
fi
